#pragma warning disable 1591
//------------------------------------------------------------------------------
// <auto-generated>
//     此代码由工具生成。
//     运行时版本:4.0.30319.42000
//
//     对此文件的更改可能会导致不正确的行为，并且如果
//     重新生成代码，这些更改将会丢失。
// </auto-generated>
//------------------------------------------------------------------------------

namespace NFinal.Compile.Template.Startup.NFinal
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    
    [System.CodeDom.Compiler.GeneratedCodeAttribute("RazorGenerator", "2.0.0.0")]
    public partial class Middleware : RazorGenerator.Templating.RazorTemplateBase
    {
#line hidden
        #line 3 "..\..\Template\Startup\NFinal\Middleware.cshtml"
           
    public Compile.Template.Startup.NFinal.MiddlewareModel Model { get; set; }

        #line default
        #line hidden
        
        public override void Execute()
        {
WriteLiteral("\r\n");

WriteLiteral(@"using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
#if (!AspNET && !NFinalOwin)
using Microsoft.Owin;
#endif
namespace NFinal
{
#if (!AspNET && !NFinalOwin)
    using AppFunc = Func<IDictionary<string, object>, Task>;
    public struct Middleware
    {
        private readonly AppFunc _next;
        private static string rootDir = null;
        public Middleware(AppFunc next)
        {
            this._next = next;
        }
        public Task Invoke(IDictionary<string, object> environment)
        {
            IOwinContext context = new OwinContext(environment);
            context.Response.ContentType = ""text/html;charset=utf-8"";
            context.Response.StatusCode = 200;
            string requestPath = context.Request.PathBase.Value + context.Request.Path.Value;
            int actionId= ActionSearch.Search(requestPath);
            if (rootDir == null)
            {
                rootDir = AppDomain.CurrentDomain.SetupInformation.ApplicationBase;
            }
            if (actionId > 0)
            {
                NFinal.Config.ConfigurationManager.Load(rootDir);
                if (NFinal.Config.ConfigurationManager.debug == true)
                {
");

            
            #line 41 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                    
            
            #line default
            #line hidden
            
            #line 41 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                      
            
            #line default
            #line hidden
            
            #line 41 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                 Write(Model.project);

            
            #line default
            #line hidden
            
            #line 41 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                                    
            
            #line default
            #line hidden
WriteLiteral(".OwinRouter.Run(context, rootDir, requestPath, actionId);\r\n                }\r\n   " +
"             else\r\n                {\r\n                    try\r\n                 " +
"   {\r\n");

            
            #line 47 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                        
            
            #line default
            #line hidden
            
            #line 47 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                          
            
            #line default
            #line hidden
            
            #line 47 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                     Write(Model.project);

            
            #line default
            #line hidden
            
            #line 47 "..\..\Template\Startup\NFinal\Middleware.cshtml"
                                        
            
            #line default
            #line hidden
WriteLiteral(".OwinRouter.Run(context, rootDir, requestPath, actionId);\r\n                    }\r" +
"\n                    catch (Exception e)\r\n                    {\r\n               " +
"         context.Response.Write(\"错误消息：<br/>\");\r\n                        context." +
"Response.Write(e.Message);\r\n                        context.Response.Write(\"<br/" +
">\");\r\n                        context.Response.Write(\"请求时发生错误：<br>\");\r\n         " +
"               context.Response.Write(requestPath);\r\n                        con" +
"text.Response.Write(\"<br/>\");\r\n                        context.Response.Write(\"请" +
"求时的Cookie:<br>\");\r\n                        foreach (var cookie in context.Reques" +
"t.Cookies)\r\n                        {\r\n                            context.Respo" +
"nse.Write(cookie.Key);\r\n                            context.Response.Write(\":\");" +
"\r\n                            context.Response.Write(cookie.Value);\r\n           " +
"                 context.Response.Write(\"<br/>\");\r\n                        }\r\n  " +
"                      context.Response.Write(\"错误跟踪：</br>\");\r\n                   " +
"     string[] stackTraces = e.StackTrace.Split(\'\\n\');\r\n                        f" +
"or (int i = 0; i < stackTraces.Length; i++)\r\n                        {\r\n        " +
"                    context.Response.Write(stackTraces[i]);\r\n                   " +
"         context.Response.Write(\"</br>\");\r\n                        }\r\n          " +
"              context.Response.Body.Close();\r\n                    }\r\n           " +
"         //return Task.FromResult(0);.net 4.5;\r\n                }\r\n             " +
"   return FromResult<int>(0);\r\n            }\r\n            else\r\n            {\r\n " +
"               return _next.Invoke(environment);\r\n            }\r\n        }\r\n    " +
"    public static Task<TResult> FromResult<TResult>(TResult resultValue)\r\n      " +
"  {\r\n            var completionSource = new TaskCompletionSource<TResult>();\r\n  " +
"          completionSource.SetResult(resultValue);\r\n            return completio" +
"nSource.Task;\r\n        }\r\n    }\r\n#endif\r\n}");

        }
    }
}
#pragma warning restore 1591
