#pragma warning disable 1591
//------------------------------------------------------------------------------
// <auto-generated>
//     此代码由工具生成。
//     运行时版本:4.0.30319.42000
//
//     对此文件的更改可能会导致不正确的行为，并且如果
//     重新生成代码，这些更改将会丢失。
// </auto-generated>
//------------------------------------------------------------------------------

namespace NFinal.Compile.Template.Startup.NFinal
{
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    
    [System.CodeDom.Compiler.GeneratedCodeAttribute("RazorGenerator", "2.0.0.0")]
    public partial class NFinalOwinMiddleware : RazorGenerator.Templating.RazorTemplateBase
    {
#line hidden
        #line 3 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
           
    public Compile.Template.Startup.NFinal.NFinalOwinMiddlewareModel Model { get; set; }

        #line default
        #line hidden
        
        public override void Execute()
        {
WriteLiteral("\r\n");

WriteLiteral(@"using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;

namespace NFinal
{
#if (!AspNET && !MicrosoftOwin)
    using AppFunc = Func<IDictionary<string, object>, Task>;
    public struct NFinalOwinMiddleware
    {
        private readonly AppFunc _next;
        private static string rootDir = null;
        public NFinalOwinMiddleware(AppFunc next)
        {
            this._next = next;
        }
        public Task Invoke(IDictionary<string, object> environment)
        {
            string requestPath = (string)environment[""owin.RequestPathBase""] + (string)environment[""owin.RequestPath""];
            int actionId= ActionSearch.Search(requestPath);
            if (rootDir == null)
            {
                rootDir = NFinal.Utility.rootPath;
            }
            if (actionId > 0)
            {
                NFinal.Config.ConfigurationManager.Load(rootDir);
                if (NFinal.Config.ConfigurationManager.debug == true)
                {
");

            
            #line 36 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                    
            
            #line default
            #line hidden
            
            #line 36 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                      
            
            #line default
            #line hidden
            
            #line 36 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                 Write(Model.project);

            
            #line default
            #line hidden
            
            #line 36 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                                    
            
            #line default
            #line hidden
WriteLiteral(".NFinalOwinRouter.Run(environment, actionId);\r\n                }\r\n               " +
" else\r\n                {\r\n                    try\r\n                    {\r\n");

            
            #line 42 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                        
            
            #line default
            #line hidden
            
            #line 42 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                          
            
            #line default
            #line hidden
            
            #line 42 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                     Write(Model.project);

            
            #line default
            #line hidden
            
            #line 42 "..\..\Template\Startup\NFinal\NFinalOwinMiddleware.cshtml"
                                        
            
            #line default
            #line hidden
WriteLiteral(".NFinalOwinRouter.Run(environment, actionId);\r\n                    }\r\n           " +
"         catch (Exception e)\r\n                    {\r\n                        NFi" +
"nal.Owin.Request request = new Owin.Request(environment);\r\n                     " +
"   NFinal.NFinalOwinBaseAction writer = new NFinalOwinBaseAction(environment, re" +
"quest,CompressMode.Deflate);\r\n                        writer.SetResponseHeader(\"" +
"Content-Type\", \"text/html; charset=utf-8\");\r\n                        writer.SetR" +
"esponseStatusCode(200);\r\n                        writer.Write(\"错误消息：<br/>\");\r\n  " +
"                      writer.Write(e.Message);\r\n                        writer.W" +
"rite(\"<br/>\");\r\n                        writer.Write(\"请求时发生错误：<br>\");\r\n         " +
"               writer.Write(requestPath);\r\n                        writer.Write(" +
"\"<br/>\");\r\n                        writer.Write(\"错误跟踪：</br>\");\r\n                " +
"        string[] stackTraces = e.StackTrace.Split(\'\\n\');\r\n                      " +
"  for (int i = 0; i < stackTraces.Length; i++)\r\n                        {\r\n     " +
"                       writer.Write(stackTraces[i]);\r\n                          " +
"  writer.Write(\"</br>\");\r\n                        }\r\n                        wri" +
"ter.Close();\r\n                    }\r\n                    //return Task.FromResul" +
"t(0);.net 4.5;\r\n                }\r\n                return FromResult<int>(0);\r\n " +
"           }\r\n            else\r\n            {\r\n                return _next.Invo" +
"ke(environment);\r\n            }\r\n        }\r\n        public static Task<TResult> " +
"FromResult<TResult>(TResult resultValue)\r\n        {\r\n            var completionS" +
"ource = new TaskCompletionSource<TResult>();\r\n            completionSource.SetRe" +
"sult(resultValue);\r\n            return completionSource.Task;\r\n        }\r\n    }\r" +
"\n#endif\r\n}");

        }
    }
}
#pragma warning restore 1591
