namespace NFinal
{
    public class ActionSearch
    {
        public static int Search(string requestedPath)
        {
			//重写虚拟目录
			//重写虚拟路径,也可以把此部分放到find中
			switch (requestedPath)
			{
				//网站图标
				case "/favicon.ico": return 0;
				case "/@{@app}/Index.html":requestedPath = "/@{@app}/IndexController/Index.html"; break;
				default: break;
			}
            //获取actionUrl
            string actionUrl = GetActionUrl(requestedPath);
            int find = GetActionId(actionUrl, requestedPath);
            return find;
        }
        /// <summary>
        /// 计算actionUrl
        /// </summary>
        /// <param name="requestedPath"></param>
        /// <returns></returns>
        private static string GetActionUrl(string requestedPath)
        {
            //找到最后一个.的位置
            int position = requestedPath.LastIndexOf('.');
            bool hasExtension = false;
            //判断是否有后缀（后缀首字母不能为数字，且长度必须大于0小于5）
            int extesionLength = requestedPath.Length - position-1;
            if (extesionLength > 0 && extesionLength < 5)
            {
                char ch = requestedPath[position + 1];
				//.后面不是数字
                if (ch > '9' || ch < '0')
                {
					hasExtension = true;
                }
            }
            //指向ActionUrl结尾的位置
            int pointer = 0;
            string actionUrl = requestedPath;
            bool hasGet = false;
            //如果有后缀
            if (hasExtension)
            {
				if(position>2)
				{
					hasGet = int.TryParse(requestedPath.Substring(position - 2, 2), out pointer);
				}
            }
            //如果没有后缀
            else
            {
				if(requestedPath.Length>2)
				{
					hasGet = int.TryParse(requestedPath.Substring(requestedPath.Length - 2, 2), out pointer);
				}
            }
            //取出ActionUrl
            if (hasGet)
            {
                if (pointer > -1 && pointer < requestedPath.Length)
                {
                    actionUrl = requestedPath.Substring(0, pointer + 1);
                }
            }
            return actionUrl;
        }
        /// <summary>
        /// 查询actionUrl
        /// </summary>
        /// <param name="app"></param>
        /// <param name="actionUrl"></param>
        /// <param name="requestedPath"></param>
        /// <returns></returns>
        private static int GetActionId(string actionUrl, string requestedPath)
        {
            int find = 0;
            //无参数
            switch (requestedPath)
            {
				case "/@{@app}/IndexController/Index.html":
                    find = 1; break;
				case "/@{@app}/Public/Header.html":
                    find = 155; break;
				case "/@{@app}/Public/Footer.html":
                    find = 156; break;
				case "/@{@app}/Public/Navigator.html":
                    find = 157; break;
				case "/@{@app}/Public/KindEditor.html":
                    find = 158; break;
				case "/@{@app}/VCode/GetVerifyImage.html":
                    find = 159; break;
                default: find = 0; break;
            }
			//有参数
			if(find==0)
			{
				switch (actionUrl)
				{
					case "/@{@app}/Public/Success/":
						find = 153; break;
					case "/@{@app}/Public/Error/":
						find = 154; break;
					case "/@{@app}/VCode/VCheck/":
						find = 160; break;
					default: find = 0; break;
				}
			}
            return find;
        }
    }
}